@{
    ViewData["Title"] = "Part - Home Page";
}
<div class="text-center">
    <h1 class="display-4">Parts</h1>
</div>
<div>
    <a asp-action="Create">Create - Part</a>
</div>


<!-- this will hold partial view (modal) -->
<div id="PlaceHolderHere"></div>
<!-- this will open modal -->
@*
    <button type="button"
            class="btn btn-primary"
            data-toggle="ajax-modal"
            data-target="#editPart"
            data-url="@Url.Action("Edit","Part",new { id= 2 })">
        Edit Part
    </button>
*@

<hr />
<p></p>
<table id="partTable" class="table table-sm table-bordered table-striped" style="width:100%">
    <thead>
        <tr>
            <th>Part Id</th>
            <th>Name</th>
            <th>Desc</th>
            <th>Customer Order #</th>
            <th>Work Order #</th>
            <th>Actions</th>
        </tr>
    </thead>
</table>


<!----delete modal--->
<div id="modal-delete" class="modal fade" role='dialog'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Are you sure want to delete !!!</h4>
                <button type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-hidden="true">
                    ×
                </button>
            </div>
            <div class="modal-body" id="modal-body-delete">   

                <p>Part Details........</p>

            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-default"
                        data-dismiss="modal">
                    Close
                </button>                
                <button class="btn btn-primary"
                        data-save="modalDelete"
                        id="deletePart"
                        type="button">
                    Delete Part
                </button>
            </div>
        </div>
    </div>
</div>
<!----delete modal--->

@section Scripts {

    <script type="text/javascript">
        $(document).ready(function () {

            var partToDelete;

            $('#floater').hide();

            var table = $('#partTable').DataTable({
                processing: true,
                ordering: true,
                paging: true,
                searching: true,
                ajax: "Part/GetAllParts",
                columns: [
                    { "data": "partId" },
                    { "data": "name" },
                    { "data": "desc" },
                    { "data": "customerOrderId" },
                    { "data": "workOrderId" },
                    {
                        "data": null, "defaultContent": "<button id='btnPartEdit' class='btn btn-success'>Edit</button><span>|</span><button id='btnPartDelete' class='btn btn-danger'>Delete</button>"
                    },
                ]
            });
            // this will open modal
            // do get-edit and display data to modal window
            var PlaceHolderElement = $('#PlaceHolderHere');
            $('#partTable tbody').on('click', '[id*=btnPartEdit]', function () {
                var data = table.row($(this).parents('tr')).data();
                console.log(data);
                var partId = data.partId;
                console.log(partId);
                var url = 'Part\\Edit\\' + partId;
                $.get(url).done(function (data) {
                    // console.log(data);
                    PlaceHolderElement.html(data);
                    PlaceHolderElement.find('.modal').modal('show');
                });
            });


           
            // delete
            // this will open modal and display data to modal window
            $('#partTable tbody').on('click', '[id*=btnPartDelete]', function () {
                var data = table.row($(this).parents('tr')).data();
                var content = "<div><span>Part # " + data.partId + "</span><br /><span>Name :  " + data.name + "</span><br /><span>Desc : " + data.desc + "</span></div>";
                console.log(content);

                $("#modal-body-delete").html('');
                $("#modal-body-delete").html(content);
                $('#modal-delete').modal('show');

                partToDelete = data.partId;
            });
            // delete
            // this will do get-delete in modal
            $('#deletePart').on('click', function (event) {
                console.log('haha');

                var url = 'Part\\Delete\\' + partToDelete;
                $.get(url).done(function (response) {
                    console.log(response);
                    console.log(response.result.statusCode);
                    console.log(response.result.message);
                    bkTimerDelete(response.result);
                });
            });
            // delete
            function bkTimerDelete(result) {

                var content = '';
                if (result.statusCode == 0) {
                    content += '<img src="../Images/success.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="green">' + result.message + '</font>';
                }
                else if (result.statusCode == -1) {
                    content += '<img src="../Images/error.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="red">' + result.message + '</font>';
                }
                else {
                    content += '<img src="../Images/error.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="red">' + result.Message + '</font>';
                }
                $("#modal-body-delete").html(content);
                $("#modal-body-delete").fadeIn("slow");
                $("#modal-body-delete").queue(function () {
                    setTimeout(function () {
                        $("#modal-body-delete").dequeue();

                        // this will hide modal
                        $('#modal-delete').modal('hide');

                        // reset partToDelete variable
                        partToDelete = 0;

                        // this will just refresh(ajax-call) datatable
                        // after success-delete
                        table.ajax.reload();
                    }, 3000);
                });
                $("#modal-body-delete").fadeOut("fast");
            };





            // this will do post-edit in modal
            PlaceHolderElement.on('click', '[data-save="modal"]', function (event) {
                var form = $(this).parents('.modal').find('form');
                var actionUrl = form.attr('action');
                var sendData = form.serialize();
                $.post(actionUrl, sendData).done(function (response) {
                    console.log(response);
                    console.log(response.result.statusCode);
                    console.log(response.result.message);
                    var mErrors = '';
                    if (response.result.statusCode == 0) {
                        bkTimer(response.result);
                        resetUI();
                    }
                    else if (response.result.statusCode == -1) {
                        bkTimer(response.result);
                        resetUI();
                    }
                    else if (response.result.statusCode == 1) {
                        // model error
                        mErrors += '<font color="red">';
                        mErrors += response.result.message;
                        mErrors += "<ul>";
                        $.each(response.result.modelErrors, function (key, value) {
                            mErrors += "<li>" + value + "</li>";
                        });
                        mErrors += "</ul></font>";
                    }
                    else {
                        bkTimer(response.result);
                        resetUI();
                    }
                    $('#opStatus').html(mErrors);
                });
            });
            // success / dal error
            function bkTimer(result) {
                var div = $("#floater");
                var content = '';
                if (result.statusCode == 0) {
                    content += '<img src="../Images/success.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="green">' + result.message + '</font>';
                }
                else if (result.statusCode == -1) {
                    content += '<img src="../Images/error.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="red">' + result.message + '</font>';
                }
                else {
                    content += '<img src="../Images/error.png" style = "width:50px;height:50px;" /> ';
                    content += '<font color="red">' + result.Message + '</font>';
                }
                div.html(content);
                div.fadeIn("slow");
                div.queue(function () {
                    setTimeout(function () {
                        div.dequeue();

                        // this will hide modal
                        PlaceHolderElement.find('.modal').modal('hide');

                        // this will refresh whole page after success-edit-delete
                        // window.location.reload(true);
                        // this will just refresh(ajax-call) datatable
                        // after success-edit
                        table.ajax.reload();

                    }, 3000);
                });
                div.fadeOut("fast");
            };
            function resetUI() {
                $('#Name').val('');
                $('#Desc').val('');
            };
        });
    </script>

    <!--
    <script src="~/js/editPart_.js"></script>
    -->


    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

}